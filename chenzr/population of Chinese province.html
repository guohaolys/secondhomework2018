<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Load GeoJSON or TopoJSON data and apply custom styling.">
    <meta name="cesium-sandcastle-labels" content="Showcases, Tutorials, DataSources">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="Cesium/Apps/Sandcastle/Sandcastle-header.js"></script>
    <script type="text/javascript" src="Cesium/ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
    require.config({
        baseUrl : 'Cesium/Source',
        waitSeconds : 60
    });
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    @import url(Cesium/Apps/Sandcastle/templates/bucket.css);
</style>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>
<script id="cesium_sandcastle_script">
function startup(Cesium) {
    'use strict';
//Sandcastle_Begin
var viewer = new Cesium.Viewer('cesiumContainer');
alert("12");  //用于调试，标记版本
viewer.dataSources.removeAll();
var count=0;

//把相机视角切换到北京上空
viewer.camera.lookAt(Cesium.Cartesian3.fromDegrees(116.3, 39.9), new Cesium.Cartesian3(0.0, -4790000.0, 3930000.0));
viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);

//province函数：利用json文件，根据各省人口数量（决定高低）绘制立体多边形
function province(path1,population1) {
    //Seed the random number generator for repeatable results.
    Cesium.Math.setRandomNumberSeed(4);
	path1+='.json';  //连接字符串形成正确路径
	var pop = population1 - 0;  //把字符串变为数字
	

    var promise = Cesium.GeoJsonDataSource.load(path1);
    promise.then(function(dataSource) {
        viewer.dataSources.add(dataSource);

        //Get the array of entities
        var entities = dataSource.entities.values;

       // var colorHash = {};
		var color = Cesium.Color.fromRandom({
                    alpha : 1.0,
                });
		//alert(color);
        for (var i = 0; i < entities.length; i++) {
            var entity = entities[i];
           // var name = entity.name;
           // colorHash[name] = color;

            //Set the polygon material to our random color.
            entity.polygon.material = color;
            //Remove the outlines.
            entity.polygon.outline = true;

            //Extrude the polygon based on the state's population.  Each entity
            //stores the properties for the GeoJSON feature it was created from
            //Since the population is a huge number, we divide by 50.
            entity.polygon.extrudedHeight = pop / 50.0;
        }
    }).otherwise(function(error){
        //Display any errrors encountered while loading.
        window.alert(error);
    });
}

function updateStats(memuse) {
	var path = "province/";
	path+=memuse.province.name1;; 
	var population = memuse.province.population;
	province(path,population);
	count++;
	//if(id==2)
	//{viewer.dataSources.removeAll();}
}

var ws = new WebSocket('ws://' + '127.0.0.1' + ':3030');
ws.onopen = function()
{
    alert("open WebSocket on server");
};
ws.onmessage = function (evt)
{
    updateStats(JSON.parse(evt.data));
	if (count==31){
	//alert("再次循环！"); 
	count=0;
	viewer.dataSources.removeAll();
    viewer.camera.lookAt(Cesium.Cartesian3.fromDegrees(116.3, 39.9), new Cesium.Cartesian3(0.0, -4790000.0, 3930000.0));
    viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
	}
};

ws.onclose = function()
{
	// websocket is closed.
	alert("Connection is closed...");
};

//    viewer.dataSources.removeAll();

//Sandcastle_End
    Sandcastle.finishedLoading();
}
if (typeof Cesium !== "undefined") {
    startup(Cesium);
} else if (typeof require === "function") {
    require(["Cesium"], startup);
}
</script>
</body>
</html>
